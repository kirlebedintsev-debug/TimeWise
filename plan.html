<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TimeWise Ultra ‚Äî —Ñ–æ–∫—É—Å, –∑–∞–¥–∞—á–∏ –∏ Pomodoro</title>
<meta name="description" content="TimeWise Ultra ‚Äî —Å—Ç–µ–∫–ª—è–Ω–Ω—ã–π –Ω–µ–æ–º–æ—Ä—Ñ–∏–∑–º 2026: Pomodoro, –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, mouse-driven 3D-–ø–∞—Ä–∞–ª–ª–∞–∫—Å." />
<meta name="keywords" content="pomodoro, —Ç–∞–π–º–µ—Ä, –∑–∞–¥–∞—á–∏, productivity, time management, neomorphism, parallax" />
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%236d28d9'/%3E%3Ctext x='50' y='58' font-size='48' text-anchor='middle' fill='%23fff' font-family='Arial'>T</text%3E%3C/svg%3E">

<!-- ApexCharts CDN -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.41.0/dist/apexcharts.min.js"></script>

<style>
  /* ================= Design tokens ================= */
  :root{
    --accent1: #6d28d9;
    --accent2: #06b6d4;
    --bg-dark-1: #071026;
    --bg-dark-2: #081a34;
    --glass-alpha: 0.10;
    --radius: 14px;
    --shadow-lg: 0 18px 40px rgba(2,6,23,0.45);
    --trans: 420ms cubic-bezier(.2,.9,.2,1);
    --text-light: #eef6ff;
    --text-dark: #071026;
    --muted-light: #9aa6be;
  }

  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text-light);background:linear-gradient(180deg,var(--bg-dark-1),var(--bg-dark-2));-webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;overflow-x:hidden}

  /* ===== background canvases (mouse-driven parallax) ===== */
  #bgCanvas, #waveCanvas { position:fixed; inset:0; z-index:0; pointer-events:none; display:block; }
  .overlay-mask{ position:fixed; inset:0; z-index:1; pointer-events:none; background:rgba(0,0,0,0.08); transition:background var(--trans) }

  /* app container */
  .site { position:relative; z-index:2; max-width:1200px; margin:28px auto; padding:18px; }

  header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px; position:relative; z-index:3 }
  .brand { font-weight:800; font-size:20px; background:linear-gradient(45deg,var(--accent1),var(--accent2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent }
  .controls { display:flex; gap:8px; align-items:center }
  .btn { padding:10px 14px; border-radius:12px; border:none; cursor:pointer; background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:white; font-weight:600; box-shadow:var(--shadow-lg); transition:transform .18s, opacity .18s }
  .btn.ghost { background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--text-light); box-shadow:none }
  .btn.small{ padding:8px 10px; font-size:13px }

  .nav { display:flex; gap:8px; }
  .nav a { text-decoration:none; color:var(--muted-light); padding:8px 10px; border-radius:8px; cursor:pointer; transition:background var(--trans), color var(--trans) }
  .nav a.active { color:var(--text-light); background:linear-gradient(90deg, rgba(124,58,237,0.12), rgba(6,182,212,0.06)); backdrop-filter:blur(6px) }

  main { min-height:70vh; padding:12px 0; position:relative; z-index:2 }

  /* view / page */
  .view { display:none; opacity:0; transform:translateY(10px) scale(.996); transition:opacity var(--trans), transform var(--trans); }
  .view.active { display:block; opacity:1; transform:translateY(0) scale(1); }

  /* cards */
  .card { background: rgba(255,255,255,var(--glass-alpha)); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow-lg); backdrop-filter: blur(10px); margin-bottom:18px; position:relative; overflow:visible; }
  .section-title { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px }
  .muted { color:var(--muted-light); font-size:13px; }

  /* layout grid on planner */
  .grid { display:grid; grid-template-columns: 1fr 380px; gap:20px; }
  @media(max-width:980px){ .grid{ grid-template-columns: 1fr } .nav{ overflow:auto } }

  /* tasks */
  .row { display:flex; gap:8px; align-items:center }
  input, textarea, select { padding:10px; border-radius:10px; border:none; background: rgba(255,255,255,0.03); color:var(--text-light); outline:none }
  .tasks-list { display:flex; flex-direction:column; gap:10px; margin-top:12px; }
  .task { display:flex; justify-content:space-between; gap:10px; padding:12px; border-radius:10px; background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent); transition:transform .28s, box-shadow .28s; }
  .task:hover{ transform: translateY(-6px) translateZ(6px); box-shadow: 0 20px 40px rgba(0,0,0,0.28) }
  .task.done{ text-decoration:line-through; opacity:0.7; background: linear-gradient(90deg, rgba(34,197,94,0.06), transparent) }

  /* pomodoro */
  .timer { text-align:center; padding:18px }
  .time-big { font-size:48px; font-weight:800; background:linear-gradient(90deg,var(--accent1),var(--accent2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent }
  .timer-controls { margin-top:12px; display:flex; gap:8px; justify-content:center }

  /* charts */
  .charts { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
  .apexcharts-canvas { height:240px !important; } /* ensure consistent height */
  @media(max-width:720px){ .time-big{ font-size:36px } .charts { grid-template-columns:1fr } .grid{ gap:12px } }

  /* Modern onboarding: overlay + highlight + tooltip */
  .tour-overlay { position:fixed; inset:0; background:rgba(2,6,23,0.70); z-index:6000; display:none; pointer-events:auto; }
  .tour-highlight { position:fixed; border-radius:12px; box-shadow:0 28px 80px rgba(109,40,217,0.28); pointer-events:none; z-index:6002; transition:all 320ms cubic-bezier(.2,.9,.2,1); border:2px solid rgba(255,255,255,0.08); }
  .tour-tooltip {
    position:fixed; z-index:6003; max-width:420px; background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.94)); color:var(--text-dark);
    border-radius:12px; padding:14px; box-shadow:0 20px 60px rgba(2,6,23,0.5); transform-origin:center top; transition:transform 260ms;
  }
  .tour-tooltip .title{ font-weight:800; margin-bottom:6px; }
  .tour-tooltip .text{ color:#334155; font-size:14px; margin-bottom:12px; }
  .tour-tooltip .actions{ display:flex; gap:8px; justify-content:flex-end; }
  .tour-arrow {
    position:absolute; width:16px; height:16px; transform:rotate(45deg); background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.94)); left:12px; top:-8px; box-shadow:0 6px 18px rgba(2,6,23,0.12);
  }

  /* small helpers */
  .hidden{ display:none }
  footer { text-align:center; margin-top:12px; color:var(--muted-light); font-size:13px }
</style>
</head>
<body>
  <!-- Background canvases -->
  <canvas id="bgCanvas" aria-hidden="true"></canvas>
  <canvas id="waveCanvas" aria-hidden="true"></canvas>
  <div class="overlay-mask" id="overlayMask" aria-hidden="true"></div>

  <div class="site" role="application" aria-labelledby="appTitle">
    <header>
      <div class="brand" id="appTitle">TimeWise Ultra</div>
      <div class="controls" role="navigation" aria-label="–ì–ª–∞–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
        <nav class="nav" id="mainNav">
          <a data-view="home" class="active" href="#home" role="button">–ì–ª–∞–≤–Ω–∞—è</a>
          <a data-view="planner" href="#planner" role="button">–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫</a>
          <a data-view="pomodoro" href="#pomodoro" role="button">Pomodoro</a>
          <a data-view="stats" href="#stats" role="button">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
        </nav>
        <button id="themeBtn" class="btn small" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåó</button>
        <button id="tourBtn" class="btn ghost small" title="–¢—É—Ä –ø–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é">üéØ –¢—É—Ä</button>
      </div>
    </header>

    <main>
      <!-- HOME -->
      <section id="home" class="view active" aria-labelledby="homeTitle">
        <div class="card">
          <div class="section-title">
            <h2 id="homeTitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ TimeWise Ultra</h2>
            <div class="muted">3D-–ø–∞—Ä–∞–ª–ª–∞–∫—Å ‚Ä¢ Pomodoro ‚Ä¢ –°—Ç–µ–∫–ª—è–Ω–Ω—ã–π UI</div>
          </div>
          <p class="muted">–£–ø—Ä–∞–≤–ª—è–π –∑–∞–¥–∞—á–∞–º–∏, –≤–∫–ª—é—á–∞–π Pomodoro –∏ —Å–ª–µ–¥–∏ –∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º. –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–ª–∞–≤–Ω–∞—è, —Ñ–æ–Ω —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –¥–≤–∏–∂–µ–Ω–∏–µ –º—ã—à–∏.</p>
          <div style="display:flex;gap:12px;margin-top:16px;flex-wrap:wrap">
            <button class="btn" onclick="showView('planner')">–ù–∞—á–∞—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
            <button class="btn ghost" onclick="showView('pomodoro')">–ó–∞–ø—É—Å—Ç–∏—Ç—å Pomodoro</button>
          </div>
        </div>
      </section>

      <!-- PLANNER -->
      <section id="planner" class="view" aria-labelledby="plannerTitle">
        <div class="card">
          <div class="section-title">
            <h2 id="plannerTitle">–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á</h2>
            <div class="muted">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ UI ‚Ä¢ –ú–µ—Ç–∫–∏: –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ/–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ/–≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
          </div>

          <form id="taskForm" onsubmit="return false;">
            <div class="row">
              <input id="taskTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" aria-label="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" />
              <input id="taskDuration" type="number" min="1" value="25" style="width:110px" aria-label="–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)" />
              <select id="taskPriority" aria-label="–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç" style="width:150px">
                <option value="1">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–≤—ã—Å–æ–∫–∏–π)</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4 (–Ω–∏–∑–∫–∏–π)</option>
              </select>
              <button id="taskAddBtn" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <textarea id="taskDesc" class="muted" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" style="margin-top:8px"></textarea>
          </form>

          <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
            <select id="filterStatus" style="width:180px"><option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option><option value="todo">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</option><option value="in_progress">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option><option value="done">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option></select>
            <input id="taskSearch" placeholder="–ü–æ–∏—Å–∫..." style="flex:1" />
            <button id="exportCsvBtn" class="btn ghost">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
            <button id="importCsvBtn" class="btn ghost">–ò–º–ø–æ—Ä—Ç CSV</button>
            <input id="importCsvInput" type="file" accept=".csv" style="display:none" />
          </div>

          <div id="tasksList" class="tasks-list" aria-live="polite" style="margin-top:12px"></div>
        </div>
      </section>

      <!-- POMODORO -->
      <section id="pomodoro" class="view" aria-labelledby="pomodoroTitle">
        <div class="card">
          <div class="section-title">
            <h2 id="pomodoroTitle">Pomodoro</h2>
            <div class="muted">–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã ‚Ä¢ –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –∑–∞–¥–∞—á–µ</div>
          </div>

          <div style="display:flex;gap:18px;flex-wrap:wrap">
            <div style="flex:1;min-width:260px">
              <div class="timer">
                <div class="time-big" id="timerDisplay">25:00</div>
                <div class="timer-controls" style="margin-top:8px">
                  <button id="pomStart" class="btn">–°—Ç–∞—Ä—Ç</button>
                  <button id="pomPause" class="btn ghost">–ü–∞—É–∑–∞</button>
                  <button id="pomSkip" class="btn ghost">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
                  <button id="pomReset" class="btn ghost">–°–±—Ä–æ—Å</button>
                </div>
                <div class="muted" style="margin-top:10px">–†–µ–∂–∏–º: <span id="pomModeLabel">–†–∞–±–æ—Ç–∞</span> ‚Ä¢ –ó–∞–≤–µ—Ä—à–µ–Ω–æ: <strong id="pomoCount">0</strong></div>
              </div>

              <div style="margin-top:12px" class="card">
                <div class="muted">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                <div style="display:flex;gap:8px;margin-top:8px">
                  <input id="workMin" type="number" min="5" value="25" style="width:100px" />
                  <input id="shortMin" type="number" min="1" value="5" style="width:100px" />
                  <input id="longMin" type="number" min="5" value="15" style="width:100px" />
                </div>
                <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
                  <label class="muted">–ê–≤—Ç–æ-—Å—Ç–∞—Ä—Ç <input id="autoStart" type="checkbox" checked style="margin-left:6px" /></label>
                  <label class="muted" style="margin-left:8px">–ê–≤—Ç–æ-—Å—Ç–∞—Ä—Ç —Å–ª–µ–¥—É—é—â–µ–≥–æ <input id="autoNext" type="checkbox" /></label>
                </div>
              </div>
            </div>

            <aside style="width:340px;min-width:260px">
              <div class="card">
                <div class="muted">–ü—Ä–∏–≤—è–∑–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –∑–∞–¥–∞—á—É</div>
                <div id="activeTaskBox" class="muted" style="margin-top:8px">–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ</div>
                <div style="margin-top:12px"><button id="bindTaskBtn" class="btn ghost">–ü—Ä–∏–≤—è–∑–∞—Ç—å –∑–∞–¥–∞—á—É –≤ —Å—Ç–∞—Ç—É—Å–µ '–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ'</button></div>
              </div>

              <div class="card" style="margin-top:12px">
                <div class="muted">–ò—Å—Ç–æ—Ä–∏—è —Å–µ—Å—Å–∏–π</div>
                <div id="historyList" style="max-height:220px;overflow:auto;margin-top:8px" class="muted"></div>
                <div style="margin-top:8px"><button id="clearHistoryBtn" class="btn ghost">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button></div>
              </div>
            </aside>
          </div>
        </div>
      </section>

      <!-- STATS -->
      <section id="stats" class="view" aria-labelledby="statsTitle">
        <div class="card">
          <div class="section-title">
            <h2 id="statsTitle">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <div class="muted">–ì—Ä–∞—Ñ–∏–∫–∏ –∑–∞ 30 –¥–Ω–µ–π</div>
          </div>
          <div class="charts" style="margin-top:12px">
            <div class="card">
              <div class="muted">–ü–æ–º–∏–¥–æ—Ä—ã (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)</div>
              <div id="chartPomo"></div>
            </div>
            <div class="card">
              <div class="muted">–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞—á (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)</div>
              <div id="chartTasks"></div>
            </div>
          </div>
          <div style="margin-top:12px" class="card">
            <div class="muted">–°—Ä–µ–¥–Ω–∏–π —Ñ–æ–∫—É—Å –≤ –º–∏–Ω—É—Ç–∞—Ö/–¥–µ–Ω—å</div>
            <div id="chartAvg"></div>
          </div>
        </div>
      </section>

    </main>

    <footer>
      TimeWise Ultra ‚Ä¢ v1.0 ‚Ä¢ ¬© 2026 ‚Äî –ª–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è. –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ (LocalStorage).
    </footer>
  </div>

  <!-- New Onboarding (manual start only) -->
  <div id="tourOverlay" class="tour-overlay" aria-hidden="true"></div>
  <div id="tourHighlight" class="tour-highlight" style="display:none"></div>
  <div id="tourTooltip" class="tour-tooltip" style="display:none" role="dialog" aria-modal="true">
    <div class="tour-arrow" id="tourArrow" style="display:block"></div>
    <div class="title" id="tourTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫</div>
    <div class="text" id="tourText">–û–ø–∏—Å–∞–Ω–∏–µ</div>
    <div class="actions">
      <div class="actions" style="display:flex;gap:8px;justify-content:flex-end">
        <button id="tourPrev" class="btn ghost small">–ù–∞–∑–∞–¥</button>
        <button id="tourNext" class="btn small">–î–∞–ª–µ–µ</button>
        <button id="tourClose" class="btn ghost small">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

<script>
/* ================= Utilities ================= */
const $ = (s) => document.querySelector(s);
const $$ = (s) => Array.from(document.querySelectorAll(s));
const uid = () => Math.random().toString(36).slice(2,9);
const nowISO = () => new Date().toISOString();
const setCookie = (n,v,d=365)=>{const dd=new Date();dd.setTime(dd.getTime()+d*24*60*60*1000);document.cookie=`${n}=${encodeURIComponent(v)};path=/;expires=${dd.toUTCString()}`};
const getCookie = n => document.cookie.split('; ').reduce((r,c)=>{const [k,v]=c.split('='); return k===n?decodeURIComponent(v):r}, null);

/* ================= State keys ================= */
const KEY_TASKS = 'tw_tasks_v2026';
const KEY_META = 'tw_meta_v2026';
const KEY_VIEW = 'tw_view_v2026';
const KEY_THEME = 'tw_theme_v2026';

/* ================= Canvas: background particles + mouse parallax ================= */
const bgCanvas = $('#bgCanvas'), bgCtx = bgCanvas.getContext('2d');
const waveCanvas = $('#waveCanvas'), waveCtx = waveCanvas.getContext('2d');
let DPR = Math.max(1, window.devicePixelRatio || 1);

function resizeCanvases(){
  bgCanvas.width = innerWidth * DPR; bgCanvas.height = innerHeight * DPR; bgCanvas.style.width = innerWidth+'px'; bgCanvas.style.height = innerHeight+'px'; bgCtx.setTransform(DPR,0,0,DPR,0,0);
  waveCanvas.width = innerWidth * DPR; waveCanvas.height = innerHeight * DPR; waveCanvas.style.width = innerWidth+'px'; waveCanvas.style.height = innerHeight+'px'; waveCtx.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener('resize', resizeCanvases);
resizeCanvases();

// particles
const PARTICLE_COUNT = Math.max(60, Math.floor((innerWidth*innerHeight)/90000));
const particles = new Array(PARTICLE_COUNT).fill(0).map(() => ({
  x: Math.random()*innerWidth, y: Math.random()*innerHeight,
  r: Math.random()*2.2+0.6, z: Math.random()*0.9+0.1,
  dx: (Math.random()-0.5)*0.4, dy: (Math.random()-0.5)*0.4
}));

let mouse = { x: innerWidth/2, y: innerHeight/2 };
window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });

function drawParticles(){
  bgCtx.clearRect(0,0,innerWidth,innerHeight);
  const g = bgCtx.createLinearGradient(0,0,innerWidth,innerHeight);
  g.addColorStop(0, 'rgba(124,58,237,0.04)');
  g.addColorStop(1, 'rgba(6,182,212,0.02)');
  bgCtx.fillStyle = g; bgCtx.fillRect(0,0,innerWidth,innerHeight);

  const cx = innerWidth/2, cy = innerHeight/2;
  particles.forEach(p => {
    const mx = (mouse.x - cx) * 0.002 * (1 - p.z);
    const my = (mouse.y - cy) * 0.002 * (1 - p.z);
    p.x += p.dx + mx;
    p.y += p.dy + my;
    if(p.x < -30) p.x = innerWidth + 30;
    if(p.x > innerWidth + 30) p.x = -30;
    if(p.y < -30) p.y = innerHeight + 30;
    if(p.y > innerHeight + 30) p.y = -30;
    bgCtx.beginPath();
    bgCtx.fillStyle = `rgba(255,255,255,${0.06*(1-p.z)+0.01})`;
    bgCtx.arc(p.x, p.y, p.r * (1 - p.z) * 2, 0, Math.PI*2);
    bgCtx.fill();
  });
  requestAnimationFrame(drawParticles);
}
drawParticles();

function runWave(colorFrom='#a78bfa', colorTo='#06b6d4', duration=900){
  const start = performance.now();
  function frame(t){
    const p = (t - start)/duration;
    waveCtx.clearRect(0,0,innerWidth,innerHeight);
    if(p > 1) return;
    const radius = Math.max(innerWidth, innerHeight) * (0.2 + p*1.8);
    const g = waveCtx.createRadialGradient(innerWidth/2, innerHeight/2, radius*0.1, innerWidth/2, innerHeight/2, radius);
    g.addColorStop(0, hexToRgba(colorFrom, 0.6*(1-p)));
    g.addColorStop(1, hexToRgba(colorTo, 0*(1-p)));
    waveCtx.fillStyle = g; waveCtx.beginPath(); waveCtx.arc(innerWidth/2, innerHeight/2, radius, 0, Math.PI*2); waveCtx.fill();
    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}
function hexToRgba(hex,a=1){ const h=hex.replace('#',''); const bi=parseInt(h.length===3? h.split('').map(c=>c+c).join(''):h,16); const r=(bi>>16)&255,g=(bi>>8)&255,b=bi&255; return `rgba(${r},${g},${b},${a})`; }

/* ================= Contrast adaptation (optional) */
function adaptOverlayForTheme(theme){
  const overlay = $('#overlayMask');
  if(theme === 'light') overlay.style.background = 'rgba(255,255,255,0.08)';
  else overlay.style.background = 'rgba(0,0,0,0.06)';
}

/* ================= Theme toggle (dark/light) ================= */
const themeBtn = $('#themeBtn');
function getSavedTheme(){ return localStorage.getItem(KEY_THEME) || getCookie(KEY_THEME) || 'dark'; }
function setSavedTheme(t){ localStorage.setItem(KEY_THEME, t); setCookie(KEY_THEME, t, 365); }
function applyTheme(theme, animate=true){
  if(theme === 'light'){ document.documentElement.style.setProperty('--text-light', '#071026'); document.body.style.background = 'linear-gradient(180deg,#f4f6fb,#eef3fb)'; }
  else { document.documentElement.style.setProperty('--text-light', '#eef6ff'); document.body.style.background = 'linear-gradient(180deg,var(--bg-dark-1),var(--bg-dark-2))'; }
  setSavedTheme(theme);
  adaptOverlayForTheme(theme);
  if(animate) runWave(theme === 'dark' ? '#a78bfa' : '#06b6d4', theme === 'dark' ? '#06b6d4' : '#a78bfa', 900);
}
themeBtn.addEventListener('click', ()=> applyTheme(getSavedTheme() === 'dark' ? 'light' : 'dark'));
applyTheme(getSavedTheme(), false);

/* ================= SPA Navigation (smooth transitions) ================= */
const views = { home: $('#home'), planner: $('#planner'), pomodoro: $('#pomodoro'), stats: $('#stats') };
let currentView = localStorage.getItem(KEY_VIEW) || 'home';

function showView(view){
  if(!views[view]) view='home';
  $$('#mainNav a').forEach(a => a.classList.toggle('active', a.dataset.view === view));
  if(views[currentView]){
    views[currentView].classList.remove('active');
    views[currentView].style.pointerEvents = 'none';
  }
  const next = views[view];
  next.style.pointerEvents = 'auto';
  next.classList.add('active');
  currentView = view;
  localStorage.setItem(KEY_VIEW, view);
  if(view === 'stats') renderStats();
}
$$('#mainNav a').forEach(a => a.addEventListener('click', (e) => { e.preventDefault(); showView(a.dataset.view); }));
showView(currentView);

/* ================= Data model: tasks & meta saved in LocalStorage ================= */
function loadTasks(){ try{ return JSON.parse(localStorage.getItem(KEY_TASKS) || '[]'); }catch(e){return [];} }
function saveTasks(ts){ localStorage.setItem(KEY_TASKS, JSON.stringify(ts)); }
function loadMeta(){ try{ return JSON.parse(localStorage.getItem(KEY_META) || '{}'); }catch(e){return {};} }
function saveMeta(m){ localStorage.setItem(KEY_META, JSON.stringify(m)); }

let tasks = loadTasks();
let meta = loadMeta();
meta.pomoCount = meta.pomoCount || 0;
meta.history = meta.history || [];
meta.settings = meta.settings || { work:25, short:5, long:15, cyclesBeforeLong:4, autoStart:false };

/* ================= Planner: CRUD, edit in UI, statuses ================= */
const tasksList = $('#tasksList'), taskForm = $('#taskForm'), taskTitle = $('#taskTitle'), taskDesc = $('#taskDesc'), taskDuration = $('#taskDuration'), taskPriority = $('#taskPriority');
const filterStatus = $('#filterStatus'), taskSearch = $('#taskSearch'), taskAddBtn = $('#taskAddBtn');

function renderTasks(){
  tasksList.innerHTML = '';
  const q = (taskSearch.value || '').toLowerCase();
  const filter = filterStatus.value;
  let list = tasks.slice().sort((a,b)=> (a.priority - b.priority) || new Date(a.createdAt) - new Date(b.createdAt));
  if(filter !== 'all') list = list.filter(x=>x.status === filter);
  if(q) list = list.filter(t => (t.title + ' ' + (t.desc||'')).toLowerCase().includes(q));
  if(!list.length){ tasksList.innerHTML = '<div class="muted">–ó–∞–¥–∞—á –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; updateCounters(); return; }

  list.forEach((t, idx) => {
    const el = document.createElement('div'); el.className = 'task' + (t.status === 'done' ? ' done' : '');
    el.innerHTML = `
      <div style="flex:1">
        <div style="display:flex;gap:10px;align-items:center"><strong>${escapeHtml(t.title)}</strong><span class="muted">‚Ä¢ ${t.duration || '‚Äî'} –º–∏–Ω</span></div>
        <div class="muted" style="margin-top:6px">${escapeHtml(t.desc || '')} ‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${t.priority}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn ghost" data-act="toggle" data-id="${t.id}" title="–û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–æ/–≤–µ—Ä–Ω—É—Ç—å"> ${t.status === 'done' ? '‚Ü∫' : '‚úî'} </button>
        <button class="btn ghost" data-act="edit" data-id="${t.id}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</button>
        <button class="btn ghost" data-act="inprog" data-id="${t.id}" title="–í –ø—Ä–æ—Ü–µ—Å—Å–µ">‚ñ∂</button>
        <button class="btn ghost" data-act="del" data-id="${t.id}" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>
      </div>
    `;
    el.style.opacity = 0; el.style.transform = 'translateY(6px)';
    tasksList.appendChild(el);
    setTimeout(()=>{ el.style.transition = 'opacity 360ms, transform 360ms'; el.style.opacity = 1; el.style.transform = 'translateY(0)'; }, idx * 45);
  });

  tasksList.querySelectorAll('button[data-act]').forEach(b => b.addEventListener('click', (ev) => {
    ev.stopPropagation();
    const id = b.dataset.id, act = b.dataset.act;
    if(act === 'toggle'){ toggleTask(id); }
    if(act === 'edit'){ editTaskUI(id); }
    if(act === 'del'){ if(confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) deleteTask(id); }
    if(act === 'inprog'){ setInProgress(id); }
  }));
  updateCounters();
  applyCardsTilt();
}

taskAddBtn.addEventListener('click', (e) => {
  e.preventDefault();
  const title = taskTitle.value.trim(); if(!title) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏'); taskTitle.focus(); return; }
  const newTask = { id: uid(), title, desc: taskDesc.value.trim(), duration: parseInt(taskDuration.value) || 25, priority: parseInt(taskPriority.value)||2, status:'todo', createdAt: nowISO(), updatedAt: nowISO() };
  tasks.push(newTask);
  saveTasks(tasks);
  taskTitle.value=''; taskDesc.value=''; taskDuration.value=25; taskPriority.value=2;
  renderTasks();
});

function toggleTask(id){ const t = tasks.find(x=>x.id===id); if(!t) return; t.status = t.status === 'done' ? 'todo' : 'done'; t.updatedAt = nowISO(); saveTasks(tasks); renderTasks(); }
function deleteTask(id){ tasks = tasks.filter(x=>x.id!==id); saveTasks(tasks); renderTasks(); }
function editTaskUI(id){
  const t = tasks.find(x=>x.id===id); if(!t) return;
  const nt = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏', t.title); if(nt !== null) t.title = nt;
  const nd = prompt('–û–ø–∏—Å–∞–Ω–∏–µ', t.desc || ''); if(nd !== null) t.desc = nd;
  const ndur = prompt('–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)', t.duration||25); if(ndur !== null) t.duration = parseInt(ndur) || t.duration;
  const npr = prompt('–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1-4', t.priority||2); if(npr !== null) t.priority = parseInt(npr) || t.priority;
  t.updatedAt = nowISO(); saveTasks(tasks); renderTasks();
}
function setInProgress(id){ tasks.forEach(x=>{ if(x.id===id) x.status='in_progress'; else if(x.status==='in_progress') x.status='todo'; }); saveTasks(tasks); renderTasks(); }

taskSearch.addEventListener('input', ()=> renderTasks());
filterStatus.addEventListener('change', ()=> renderTasks());

/* Export / Import CSV & JSON */
$('#exportCsvBtn').addEventListener('click', ()=> {
  let csv = '–ù–∞–∑–≤–∞–Ω–∏–µ,–û–ø–∏—Å–∞–Ω–∏–µ,–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å,–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç,–°—Ç–∞—Ç—É—Å,createdAt\n';
  tasks.forEach(t => csv += `"${t.title.replace(/"/g,'""')}","${(t.desc||'').replace(/"/g,'""')}",${t.duration||''},${t.priority||''},${t.status||''},${t.createdAt}\n`);
  downloadBlob(csv, 'tasks.csv', 'text/csv');
});
$('#importCsvBtn').addEventListener('click', ()=> $('#importCsvInput').click());
$('#importCsvInput').addEventListener('change', e => {
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ev => {
    const lines = ev.target.result.split(/\r?\n/).slice(1).filter(Boolean);
    lines.forEach(line => {
      const vals = parseCSVLine(line);
      if(vals[0]) tasks.push({ id: uid(), title: vals[0], desc: vals[1]||'', duration: parseInt(vals[2])||25, priority: parseInt(vals[3])||2, status: vals[4]||'todo', createdAt: nowISO(), updatedAt: nowISO() });
    });
    saveTasks(tasks); renderTasks();
  };
  r.readAsText(f,'utf-8');
});

function parseCSVLine(line){
  const res=[]; let cur='', inQ=false;
  for(let i=0;i<line.length;i++){ const ch=line[i];
    if(inQ){ if(ch==='"' && line[i+1]==='"'){ cur+='"'; i++; continue; } if(ch==='"'){ inQ=false; continue; } cur+=ch; }
    else { if(ch==='"'){ inQ=true; continue; } if(ch===','){ res.push(cur); cur=''; continue; } cur+=ch; }
  }
  res.push(cur); return res;
}
function downloadBlob(content, filename, type='text/plain'){ const blob = new Blob([content], {type}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); a.remove(); }

/* ================= Update counters and misc ================= */
function updateCounters(){
  $('#pomoCount').textContent = meta.pomoCount || 0;
}
updateCounters();

/* ================= Pomodoro logic (persistent) ================= */
let timer = null;
meta.settings = meta.settings || { work:25, short:5, long:15, cyclesBeforeLong:4, autoStart:false };
let remaining = parseInt(meta._remaining) || (meta.settings.work * 60);
let mode = meta._mode || 'work'; // 'work' | 'short' | 'long'
let cycleCount = meta._cycleCount || 0;
let boundTask = meta._boundTask || null;

const timerDisplay = $('#timerDisplay'), pomModeLabel = $('#pomModeLabel'), pomoCountEl = $('#pomoCount');

function savePomState(){ meta._remaining = remaining; meta._mode = mode; meta._cycleCount = cycleCount; meta._boundTask = boundTask; saveMeta(meta); }

function updateTimerUI(){
  const m = Math.floor(remaining/60), s = remaining % 60;
  timerDisplay.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  pomModeLabel.textContent = mode === 'work' ? '–†–∞–±–æ—Ç–∞' : (mode === 'short' ? '–ö–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–µ—Ä—ã–≤' : '–î–ª–∏–Ω–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤');
  pomoCountEl.textContent = meta.pomoCount || 0;
}
updateTimerUI();

function startPomodoro(){
  if(timer) return;
  applyPomSettings();
  timer = setInterval(()=> {
    remaining--; updateTimerUI();
    if(remaining <= 0){
      clearInterval(timer); timer = null;
      completeSession(false);
    }
  }, 1000);
}
function pausePomodoro(){ if(timer){ clearInterval(timer); timer = null; savePomState(); } }
function resetPomodoro(){ pausePomodoro(); mode = 'work'; remaining = meta.settings.work * 60; cycleCount = 0; boundTask = null; savePomState(); updateTimerUI(); }
function skipPomodoro(){ if(timer){ clearInterval(timer); timer = null; } completeSession(true); }

$('#pomStart').addEventListener('click', startPomodoro);
$('#pomPause').addEventListener('click', pausePomodoro);
$('#pomReset').addEventListener('click', resetPomodoro);
$('#pomSkip').addEventListener('click', skipPomodoro);

function applyPomSettings(){
  meta.settings.work = parseInt($('#workMin').value) || meta.settings.work;
  meta.settings.short = parseInt($('#shortMin').value) || meta.settings.short;
  meta.settings.long = parseInt($('#longMin').value) || meta.settings.long;
  meta.settings.cyclesBeforeLong = parseInt($('#cyclesBeforeLong')?.value) || meta.settings.cyclesBeforeLong || 4;
  meta.settings.autoStart = !!$('#autoStart').checked;
  saveMeta(meta);
}

function completeSession(skipped){
  const entry = { ts: nowISO(), mode, skipped: !!skipped, taskId: boundTask || null };
  meta.history = meta.history || []; meta.history.push(entry);
  if(mode === 'work' && !skipped){
    meta.pomoCount = (meta.pomoCount || 0) + 1;
    if(boundTask){
      const t = tasks.find(x=>x.id===boundTask);
      if(t){
        t.duration = Math.max(0, (t.duration||0) - (meta.settings.work || 25));
        if((t.duration||0) <= 0) t.status = 'done';
        t.updatedAt = nowISO();
        saveTasks(tasks); renderTasks();
      }
    }
  }
  if(mode === 'work'){
    cycleCount++;
    if(cycleCount % (meta.settings.cyclesBeforeLong || 4) === 0){ mode = 'long'; remaining = (meta.settings.long || 15) * 60; }
    else { mode = 'short'; remaining = (meta.settings.short || 5) * 60; }
  } else {
    mode = 'work'; remaining = (meta.settings.work || 25) * 60;
  }
  saveMeta(meta); savePomState();
  renderHistory();
  try{ new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg').play(); if(navigator.vibrate) navigator.vibrate(180); } catch(e){}
  if(meta.settings.autoStart) startPomodoro();
  else notifyBrowser('Pomodoro –∑–∞–≤–µ—Ä—à—ë–Ω', '–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚Äî —Å–¥–µ–ª–∞–π –ø–µ—Ä–µ—Ä—ã–≤.');
  updateTimerUI();
}

$('#bindTaskBtn').addEventListener('click', ()=> {
  const inprog = tasks.find(t=>t.status === 'in_progress');
  if(!inprog) return alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–º–µ—Ç—å—Ç–µ –∑–∞–¥–∞—á—É –∫–∞–∫ "–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ".');
  boundTask = inprog.id;
  $('#activeTaskBox').textContent = `–ü—Ä–∏–≤—è–∑–∞–Ω–æ: ${inprog.title}`;
  savePomState();
});

function renderHistory(){
  const root = $('#historyList'); root.innerHTML = '';
  (meta.history || []).slice().reverse().slice(0,200).forEach(h => {
    const d = new Date(h.ts);
    const el = document.createElement('div'); el.style.padding = '8px 0';
    el.innerHTML = `<div style="font-weight:600">${h.mode}</div><div class="muted">${d.toLocaleString()} ${h.skipped?'<em>(–ø—Ä–æ–ø—É—â–µ–Ω–æ)</em>':''} ${h.taskId?`‚Ä¢ ${(tasks.find(t=>t.id===h.taskId)||{title:'‚Äî'}).title}`:''}</div>`;
    root.appendChild(el);
  });
  updateCounters();
}
$('#clearHistoryBtn').addEventListener('click', ()=> { if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é Pomodoro?')){ meta.history = []; saveMeta(meta); renderHistory(); } });
renderHistory();

/* ================= Browser notifications helper ================= */
function notifyBrowser(title, body){
  if('Notification' in window){
    if(Notification.permission === 'granted') new Notification(title, { body });
    else if(Notification.permission !== 'denied') Notification.requestPermission().then(p => { if(p === 'granted') new Notification(title,{body}); });
  }
}

/* ================= ApexCharts: rendering improved charts ================= */
let chartPomo = null, chartTasks = null, chartAvg = null;
function computeWindow(days=30){
  const labels=[], pomoData=[], tasksDone=[];
  const today = new Date(); today.setHours(0,0,0,0);
  for(let i=days-1;i>=0;i--){
    const d = new Date(today); d.setDate(today.getDate()-i); labels.push(d.toLocaleDateString());
    const start = new Date(d); start.setHours(0,0,0,0); const end = new Date(d); end.setHours(23,59,59,999);
    const pomos = (meta.history || []).filter(h => { const ts = new Date(h.ts); return ts >= start && ts <= end && h.mode === 'work' && !h.skipped; }).length;
    pomoData.push(pomos);
    const done = tasks.filter(t => t.status === 'done' && new Date(t.updatedAt || t.createdAt) >= start && new Date(t.updatedAt || t.createdAt) <= end).length;
    tasksDone.push(done);
  }
  const avgFocus = (pomoData.reduce((a,b)=>a+b,0) * (meta.settings.work || 25)) / labels.length;
  return { labels, pomoData, tasksDone, avgFocus };
}

/* helper: detect small screen (reduce/disable animation) */
const IS_MOBILE = window.matchMedia('(max-width:720px)').matches;

function renderStats(){
  const st = computeWindow(30);
  // destroy if exist
  if(chartPomo) chartPomo.destroy();
  if(chartTasks) chartTasks.destroy();
  if(chartAvg) chartAvg.destroy();

  // shared options pieces
  const commonStroke = { curve: 'smooth', width: 3, dashArray: 0, lineCap: 'round' };
  const anima = IS_MOBILE ? { enabled: true, easing: 'linear', speed: 400 } : { enabled: true, easing: 'easeinout', speed: 900 };
  // gradient colors consistent with Tilda purple-blue
  const purple = '#7c5cff';
  const aqua = '#06b6d4';

  // Pomo: line with gradient + glow
  const optsPomo = {
    chart: { type: 'area', height: 240, animations: anima, toolbar: { show:false }, zoom: { enabled:false } },
    series: [{ name: '–ü–æ–º–∏–¥–æ—Ä—ã', data: st.pomoData }],
    stroke: commonStroke,
    fill: { type: 'gradient', gradient: { shade: 'light', type: 'vertical', shadeIntensity: 0.6, gradientToColors: [aqua], inverseColors: false, opacityFrom: 0.9, opacityTo: 0.05, stops: [0,60,100] } },
    markers: { size: 4, hover: { size: 6 } },
    colors: [purple],
    tooltip: { theme: 'light' },
    grid: { strokeDashArray: 6 },
    yaxis: { labels: { formatter: v => Math.round(v).toString() } },
    xaxis: { categories: st.labels, labels: { rotate: -35 } },
    chartOptions: {}
  };
  chartPomo = new ApexCharts($('#chartPomo'), optsPomo);
  chartPomo.render();

  // Tasks: column with subtle rounded bars
  const optsTasks = {
    chart: { type: 'bar', height: 240, animations: anima, toolbar:{show:false} },
    series: [{ name: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ', data: st.tasksDone }],
    plotOptions: { bar: { borderRadius: 8, columnWidth: '56%' } },
    colors: [aqua],
    tooltip: { theme: 'light' },
    xaxis: { categories: st.labels, labels: { rotate: -35 } },
    yaxis: { labels: { formatter: v => Math.round(v).toString() } },
    grid: { strokeDashArray:6 }
  };
  chartTasks = new ApexCharts($('#chartTasks'), optsTasks);
  chartTasks.render();

  // Avg focus: area, smoothed, subtle glow
  const avgPerDay = st.pomoData.map(x => x * (meta.settings.work || 25));
  const optsAvg = {
    chart: { type: 'area', height: 240, animations: anima, toolbar:{show:false} },
    series: [{ name: '–§–æ–∫—É—Å (–º–∏–Ω/–¥)', data: avgPerDay }],
    stroke: commonStroke,
    fill: { type: 'gradient', gradient: { shade: 'dark', gradientToColors: [purple], opacityFrom: 0.7, opacityTo: 0.04 } },
    colors: ['rgba(124,58,237,0.95)'],
    markers: { size: 3 },
    tooltip: { theme: 'light' },
    xaxis: { categories: st.labels, labels: { rotate: -35 } },
    yaxis: { labels: { formatter: v => Math.round(v).toString() } },
    grid: { strokeDashArray:6 }
  };
  chartAvg = new ApexCharts($('#chartAvg'), optsAvg);
  chartAvg.render();
}

/* update charts on theme change or resize (simple) */
window.addEventListener('resize', () => { if(currentView === 'stats') { if(chartPomo) chartPomo.updateOptions({}, false); if(chartTasks) chartTasks.updateOptions({}, false); if(chartAvg) chartAvg.updateOptions({}, false); } });

/* ================= Onboarding: custom modern tour (manual only) ================= */
/* Steps: selector, title, text, preferred placement (top/right/bottom/left) */
const TOUR_STEPS = [
  { el: '#mainNav a[data-view="planner"]', title: '–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫', text: '–î–æ–±–∞–≤–ª—è–π –∑–∞–¥–∞—á–∏, —É–∫–∞–∑—ã–≤–∞–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å. –ó–¥–µ—Å—å —Ç—ã –Ω–∞—á–Ω—ë—à—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–µ–Ω—å.', place: 'bottom' },
  { el: '#tasksList', title: '–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á', text: '–í—Å–µ –∑–∞–¥–∞—á–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∑–¥–µ—Å—å ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π, –æ—Ç–º–µ—á–∞–π "–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ" –∏–ª–∏ "–≤—ã–ø–æ–ª–Ω–µ–Ω–æ".', place: 'right' },
  { el: '#pomStart', title: '–ó–∞–ø—É—Å–∫ Pomodoro', text: '–ö–Ω–æ–ø–∫–∞ –°—Ç–∞—Ä—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ä–∞–±–æ—á—É—é —Å–µ—Å—Å–∏—é ‚Äî –º–æ–∂–Ω–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å –∑–∞–¥–∞—á—É.', place: 'left' },
  { el: '#stats', title: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', text: '–ó–¥–µ—Å—å –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≥—Ä–∞—Ñ–∏–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞ 30 –¥–Ω–µ–π ‚Äî –∑–∞—Ö–æ–¥–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–∏–Ω–∞–º–∏–∫—É.', place: 'top' }
];

const tourOverlay = $('#tourOverlay'), tourHighlight = $('#tourHighlight'), tourTooltip = $('#tourTooltip'), tourTitle = $('#tourTitle'), tourText = $('#tourText');
const tourPrev = $('#tourPrev'), tourNext = $('#tourNext'), tourClose = $('#tourClose');
let tourIndex = 0;

function showTourStep(i){
  tourIndex = i;
  const step = TOUR_STEPS[i];
  if(!step) return endTour();
  const el = document.querySelector(step.el);
  // if element is on different view ‚Äî switch view
  if(el){
    const parentView = findParentView(el);
    if(parentView) showView(parentView);
    // small delay for view animation
    setTimeout(()=> {
      positionHighlightAndTooltip(el, step.place);
      tourTitle.textContent = step.title;
      tourText.textContent = step.text;
      tourOverlay.style.display = 'block';
      tourHighlight.style.display = 'block';
      tourTooltip.style.display = 'block';
      // disable page scroll while tour active
      document.body.style.overflow = 'hidden';
    }, 260);
  } else {
    // if no element found, show generic tooltip in center
    tourOverlay.style.display = 'block';
    tourHighlight.style.display = 'none';
    tourTooltip.style.display = 'block';
    tourTooltip.style.left = '50%'; tourTooltip.style.top = '40%';
    tourTooltip.style.transform = 'translate(-50%,0)';
    tourTitle.textContent = step.title;
    tourText.textContent = step.text;
    document.body.style.overflow = 'hidden';
  }
  // update buttons
  tourPrev.disabled = i === 0;
  tourNext.textContent = i === TOUR_STEPS.length - 1 ? '–ì–æ—Ç–æ–≤–æ' : '–î–∞–ª–µ–µ';
}

function findParentView(el){
  let p = el;
  while(p && p !== document.body){
    if(p.classList && p.classList.contains('view')) return p.id;
    p = p.parentElement;
  }
  return null;
}

function positionHighlightAndTooltip(targetEl, place='bottom'){
  const r = targetEl.getBoundingClientRect();
  const padding = 12;
  const left = Math.max(8, r.left - padding);
  const top = Math.max(8, r.top - padding);
  tourHighlight.style.left = `${left}px`;
  tourHighlight.style.top = `${top}px`;
  tourHighlight.style.width = `${r.width + padding*2}px`;
  tourHighlight.style.height = `${r.height + padding*2}px`;
  // place tooltip intelligently
  const tt = tourTooltip;
  const margin = 12;
  let ttLeft = left, ttTop = top;
  // default positions
  if(place === 'bottom'){
    ttLeft = left;
    ttTop = top + r.height + padding + margin;
    tt.style.transform = 'translate(0,0)';
  } else if(place === 'top'){
    ttLeft = left;
    ttTop = top - 12 - 120; // approximate
  } else if(place === 'right'){
    ttLeft = left + r.width + padding + margin;
    ttTop = top;
  } else if(place === 'left'){
    ttLeft = Math.max(8, left - 440);
    ttTop = top;
  }
  // clamp inside viewport
  const maxLeft = window.innerWidth - 440 - 16;
  if(ttLeft > maxLeft) ttLeft = maxLeft;
  if(ttLeft < 8) ttLeft = 8;
  if(ttTop + 120 > window.innerHeight - 40) ttTop = Math.max(8, window.innerHeight - 200);
  tt.style.left = `${ttLeft}px`;
  tt.style.top = `${ttTop}px`;
  // arrow rotate: adjust small arrow position at top of tooltip if tooltip is above target
  const arrow = $('#tourArrow');
  if(place === 'top'){ arrow.style.top = 'auto'; arrow.style.bottom = '-8px'; arrow.style.left = '20px'; arrow.style.transform = 'rotate(45deg)'; }
  else { arrow.style.top = '-8px'; arrow.style.bottom = 'auto'; arrow.style.left = '12px'; arrow.style.transform = 'rotate(45deg)'; }
}

function nextTour(){ if(tourIndex < TOUR_STEPS.length - 1) showTourStep(tourIndex + 1); else endTour(); }
function prevTour(){ if(tourIndex > 0) showTourStep(tourIndex - 1); }

function endTour(){
  tourOverlay.style.display = 'none';
  tourHighlight.style.display = 'none';
  tourTooltip.style.display = 'none';
  document.body.style.overflow = '';
  // do not set cookie ‚Äî user wanted manual-only tour; keep it manual
}

$('#tourBtn').addEventListener('click', ()=> showTourStep(0));
tourNext.addEventListener('click', nextTour);
tourPrev.addEventListener('click', prevTour);
tourClose.addEventListener('click', endTour);

/* ================= Cards tilt (3D subtle tilt on mouse move over card) ================= */
function applyCardsTilt(){
  $$('.card').forEach(card=>{
    card.addEventListener('mousemove', (e)=>{
      const rect = card.getBoundingClientRect();
      const cx = rect.left + rect.width/2, cy = rect.top + rect.height/2;
      const dx = (e.clientX - cx)/rect.width, dy = (e.clientY - cy)/rect.height;
      const rx = (-dy * 6).toFixed(2), ry = (dx * 6).toFixed(2);
      card.style.transform = `perspective(900px) rotateX(${rx}deg) rotateY(${ry}deg) translateZ(6px)`;
    });
    card.addEventListener('mouseleave', ()=> { card.style.transform = ''; });
  });
}
applyCardsTilt();

/* ================= Utilities ================= */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ================= Keyboard shortcuts ================= */
document.addEventListener('keydown', e=>{
  if(e.key.toLowerCase() === 's'){ startPomodoro(); }
  if(e.key.toLowerCase() === 'p'){ pausePomodoro(); }
  if(e.key.toLowerCase() === 'r'){ resetPomodoro(); }
  if(e.key === '/' && document.activeElement !== $('#taskSearch')){ e.preventDefault(); $('#taskSearch').focus(); }
});

/* ================= Initialization & restore ================= */
renderTasks();
renderHistory();
renderStats();
updateTimerUI();
adaptOverlayForTheme(getSavedTheme());
setInterval(()=> saveMeta(meta), 5000);
window.addEventListener('load', ()=> { resizeCanvases(); resizeCanvases(); });

</script>
</body>
</html>
